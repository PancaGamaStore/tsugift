<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tsukoyomi Store - MLBB Gift Skin & Top Up</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
    <style>
        /* (CSS tetap sama seperti sebelumnya) */
        .banner-slide {
            animation: slide 12s infinite ease-in-out;
        }
        @keyframes slide {
            0%, 25% { opacity: 1; transform: translateX(0); }
            30%, 45% { opacity: 0; transform: translateX(-100%); }
            50%, 75% { opacity: 1; transform: translateX(0); }
            80%, 100% { opacity: 0; transform: translateX(100%); }
        }
        .banner-slide:nth-child(2) { animation-delay: 4s; }
        .banner-slide:nth-child(3) { animation-delay: 8s; }
        .flash-sale-slide {
            transition: opacity 0.5s ease, transform 0.5s ease;
            opacity: 0;
            transform: translateY(20px);
            position: absolute;
            width: 100%;
        }
        .flash-sale-slide.active {
            opacity: 1;
            transform: translateY(0);
        }
        .lightning {
            animation: flash 1s infinite;
        }
        @keyframes flash {
            0%, 50%, 100% { transform: translateY(0); opacity: 1; }
            25%, 75% { transform: translateY(-5px); opacity: 0.7; }
        }
        .spinner {
            display: none;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin-left: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .product-btn, .flash-sale-btn, .denom-btn, .payment-btn {
            transition: all 0.3s ease;
        }
        .product-btn:hover, .flash-sale-btn:hover, .denom-btn:hover, .payment-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .product-btn {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .selected {
            background-color: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
        }
        .fade-enter {
            animation: fadeIn 0.5s ease-in;
        }
        .fade-exit {
            animation: fadeOut 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-10px); }
        }
        .validation-message {
            transition: opacity 0.3s ease, transform 0.3s ease;
            opacity: 0;
            transform: translateY(5px);
        }
        .validation-message.show {
            opacity: 1;
            transform: translateY(0);
        }
        .nav-btn {
            transition: background-color 0.3s ease;
        }
        .nav-btn:hover {
            background-color: #2563eb;
        }
        .purchase-popup {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: white;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            max-width: 300px;
            z-index: 1000;
            transition: opacity 0.5s ease, transform 0.5s ease;
            opacity: 0;
            transform: translateY(20px);
        }
        .purchase-popup.active {
            opacity: 1;
            transform: translateY(0);
        }
        .popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .popup-content {
            background: white;
            padding: 24px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            animation: popupIn 0.3s ease;
        }
        @keyframes popupIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-blue-600 text-white py-4 shadow-md">
        <h1 class="text-3xl font-bold text-center">Tsukoyomi Store</h1>
    </header>

    <div class="container mx-auto p-4 max-w-2xl flex-grow">
        <!-- Login Page -->
        <div id="loginPage" class="block">
            <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">Login</h2>
            <form id="loginForm" class="bg-white p-6 rounded-xl shadow-lg">
                <div class="mb-4">
                    <label for="loginEmail" class="block text-gray-700 font-semibold mb-2">Email</label>
                    <input type="email" id="loginEmail" name="email" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Enter Email" required>
                </div>
                <div class="mb-4">
                    <label for="loginPassword" class="block text-gray-700 font-semibold mb-2">Password</label>
                    <input type="password" id="loginPassword" name="password" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Enter Password" required>
                </div>
                <div class="mb-4">
                    <p id="loginMessage" class="text-sm mt-1 validation-message"></p>
                </div>
                <button type="submit" class="w-full bg-blue-500 text-white p-2 rounded-xl hover:bg-blue-600 transition-colors">Login</button>
                <p class="text-center mt-4 text-gray-600">Don't have an account? <a href="#" id="showRegister" class="text-blue-500 underline">Register</a></p>
            </form>
        </div>

        <!-- Register Page -->
        <div id="registerPage" class="hidden">
            <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">Register</h2>
            <form id="registerForm" class="bg-white p-6 rounded-xl shadow-lg">
                <div class="mb-4">
                    <label for="registerEmail" class="block text-gray-700 font-semibold mb-2">Email</label>
                    <input type="email" id="registerEmail" name="email" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Enter Email" required>
                </div>
                <div class="mb-4">
                    <label for="registerPassword" class="block text-gray-700 font-semibold mb-2">Password</label>
                    <input type="password" id="registerPassword" name="password" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Enter Password" required>
                </div>
                <div class="mb-4">
                    <p id="registerMessage" class="text-sm mt-1 validation-message"></p>
                </div>
                <button type="submit" class="w-full bg-blue-500 text-white p-2 rounded-xl hover:bg-blue-600 transition-colors">Register</button>
                <p class="text-center mt-4 text-gray-600">Already have an account? <a href="#" id="showLogin" class="text-blue-500 underline">Login</a></p>
            </form>
        </div>

        <!-- Homepage -->
        <div id="homePage" class="hidden">
            <!-- Profile Section -->
            <div class="mb-6 bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-bold mb-4 text-gray-800">Profile</h2>
                <p id="profileEmail" class="text-gray-700"></p>
                <div class="mt-4 flex gap-2">
                    <button id="adminBtn" class="hidden bg-purple-500 text-white p-2 rounded-xl hover:bg-purple-600 transition-colors">Admin Panel</button>
                    <button id="logoutBtn" class="bg-red-500 text-white p-2 rounded-xl hover:bg-red-600 transition-colors">Logout</button>
                </div>
            </div>

            <!-- Order History -->
            <div class="mb-6 bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-bold mb-4 text-gray-800">Order History</h2>
                <div id="orderHistory" class="text-gray-700"></div>
            </div>

            <!-- Banner -->
            <div class="relative w-full h-48 mb-6 overflow-hidden rounded-xl shadow-lg">
                <img src="/images/banners/banner1.jpg" class="banner-slide absolute w-full h-full object-cover" alt="Banner 1">
                <img src="/images/banners/banner2.jpg" class="banner-slide absolute w-full h-full object-cover opacity-0" alt="Banner 2">
                <img src="/images/banners/banner3.jpg" class="banner-slide absolute w-full h-full object-cover opacity-0" alt="Banner 3">
            </div>

            <!-- Flash Sale -->
            <div class="mb-6">
                <h2 class="text-xl font-bold text-center mb-4 text-gray-800">Flash Sale</h2>
                <div class="relative w-full h-20 overflow-hidden">
                    <div id="flashSaleContainer"></div>
                </div>
                <div class="flex justify-between mt-2">
                    <button id="prevFlashSale" class="nav-btn bg-blue-500 text-white p-2 rounded-full hover:bg-blue-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                    </button>
                    <button id="nextFlashSale" class="nav-btn bg-blue-500 text-white p-2 rounded-full hover:bg-blue-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Product Grid -->
            <h2 class="text-2xl font-bold text-center mb-8 text-gray-800">Our Products</h2>
            <div id="productGrid" class="grid grid-cols-2 gap-4 mb-8"></div>

            <!-- Website Description -->
            <div class="text-center mb-8">
                <h3 class="text-lg font-semibold mb-2 text-gray-800">About Tsukoyomi Store</h3>
                <p class="text-gray-600">Welcome to Tsukoyomi Store, your trusted destination for Mobile Legends: Bang Bang (MLBB) gift skins and top-ups. We offer a variety of products including MLA, MLB, WDP, and exclusive gift skins at competitive prices. Enjoy fast and secure transactions with our easy-to-use platform!</p>
            </div>

            <!-- Purchase Popup -->
            <div id="purchasePopup" class="purchase-popup">
                <div id="purchaseContent" class="text-sm text-gray-700"></div>
            </div>
        </div>

        <!-- Order Form -->
        <div id="orderFormPage" class="hidden">
            <h1 class="text-2xl font-bold text-center mb-6 text-gray-800">Order <span id="productTitle"></span></h1>
            <form id="orderForm" class="bg-white p-6 rounded-xl shadow-lg">
                <!-- Denomination Selection -->
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">Select Denomination</label>
                    <div id="denomGrid" class="grid grid-cols-2 gap-2"></div>
                    <input type="hidden" id="denomination" name="denomination" required>
                    <input type="hidden" id="price" name="price" required>
                </div>

                <!-- User ID and Server -->
                <div class="mb-4">
                    <label for="userId" class="block text-gray-700 font-semibold mb-2">User ID</label>
                    <div class="flex items-center">
                        <input type="text" id="userId" name="userId" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Enter User ID" required>
                        <div id="userIdSpinner" class="spinner"></div>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="serverId" class="block text-gray-700 font-semibold mb-2">Server ID</label>
                    <div class="flex items-center">
                        <input type="text" id="serverId" name="serverId" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Enter Server ID" required>
                        <div id="serverIdSpinner" class="spinner"></div>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="username" class="block text-gray-700 font-semibold mb-2">Username</label>
                    <input type="text" id="username" name="username" class="w-full p-2 border rounded bg-gray-100" readonly>
                </div>
                <div class="mb-4">
                    <label for="region" class="block text-gray-700 font-semibold mb-2">Region</label>
                    <input type="text" id="region" name="region" class="w-full p-2 border rounded bg-gray-100" readonly>
                </div>
                <div class="mb-4">
                    <p id="validationMessage" class="text-sm mt-1 validation-message"></p>
                </div>

                <!-- Payment Method Selection -->
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">Select Payment Method</label>
                    <div class="grid grid-cols-2 gap-2">
                        <button type="button" class="payment-btn flex items-center p-2 border rounded-xl hover:bg-gray-100 transition-colors" data-payment="QRIS">
                            <img src="/images/payments/qris.png" alt="QRIS" class="w-8 h-8 mr-2">
                            <span>QRIS</span>
                        </button>
                        <button type="button" class="payment-btn flex items-center p-2 border rounded-xl hover:bg-gray-100 transition-colors" data-payment="Bank Transfer">
                            <img src="/images/payments/bank-transfer.png" alt="Bank Transfer" class="w-8 h-8 mr-2">
                            <span>Bank Transfer</span>
                        </button>
                    </div>
                    <input type="hidden" id="paymentMethod" name="paymentMethod" required>
                </div>

                <!-- Submit and Back Buttons -->
                <div class="flex gap-2">
                    <button type="button" id="backBtn" class="w-1/2 bg-gray-500 text-white p-2 rounded-xl hover:bg-gray-600 transition-colors">Back</button>
                    <button type="submit" id="submitBtn" class="w-1/2 bg-blue-500 text-white p-2 rounded-xl hover:bg-blue-600 transition-colors" disabled>Proceed to WhatsApp</button>
                </div>
            </form>

            <!-- Confirmation Popup -->
            <div id="confirmationPopup" class="popup hidden">
                <div class="popup-content">
                    <h2 class="text-xl font-bold mb-4 text-gray-800">Confirm Your Order</h2>
                    <div id="popupContent" class="text-gray-700 mb-6"></div>
                    <div class="flex gap-2">
                        <button id="cancelPopup" class="w-1/2 bg-gray-500 text-white p-2 rounded-xl hover:bg-gray-600 transition-colors">Cancel</button>
                        <button id="confirmPopup" class="w-1/2 bg-blue-500 text-white p-2 rounded-xl hover:bg-blue-600 transition-colors">Confirm</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Panel -->
        <div id="adminPage" class="hidden">
            <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">Admin Panel - User Management</h2>
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <table class="w-full text-left text-gray-700">
                    <thead>
                        <tr>
                            <th class="p-2">Email</th>
                            <th class="p-2">Role</th>
                            <th class="p-2">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="userTable"></tbody>
                </table>
                <button id="backToHomeBtn" class="mt-4 bg-gray-500 text-white p-2 rounded-xl hover:bg-gray-600 transition-colors">Back to Home</button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-blue-600 text-white py-4 mt-8">
        <div class="container mx-auto text-center">
            <p>&copy; 2025 Tsukoyomi Store. All rights reserved.</p>
            <p>Contact us: <a href="https://wa.me/+6281234567890" class="underline">WhatsApp</a> | Email: support@tsukoyomistore.com</p>
        </div>
    </footer>

    <script>
        // Initialize Firebase with error handling
        let auth;
        try {
            console.log('Attempting to initialize Firebase');
            const firebaseConfig = JSON.parse('<%- process.env.FIREBASE_CONFIG %>');
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            console.log('Firebase initialized successfully');
        } catch (error) {
            console.error('Firebase initialization error:', error.message);
            document.getElementById('registerMessage').textContent = 'Failed to initialize Firebase. Please try again later.';
            document.getElementById('registerMessage').classList.add('text-red-500', 'show');
            document.getElementById('loginMessage').textContent = 'Failed to initialize Firebase. Please try again later.';
            document.getElementById('loginMessage').classList.add('text-red-500', 'show');
        }

        // Utility to get cookie
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        // Utility to set cookie
        function setCookie(name, value, minutes) {
            const date = new Date();
            date.setTime(date.getTime() + (minutes * 60 * 1000));
            document.cookie = `${name}=${value};expires=${date.toUTCString()};path=/;Secure;SameSite=Strict`;
        }

        // Utility to delete cookie
        function deleteCookie(name) {
            document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;Secure;SameSite=Strict`;
        }

        // Check authentication on page load
        async function checkAuth() {
            if (!auth) {
                console.error('Auth not initialized');
                return null;
            }
            console.log('Checking auth state');
            return new Promise((resolve) => {
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        console.log('User authenticated:', user.email);
                        try {
                            const response = await fetch('/api/validate', {
                                headers: { 'Authorization': `Bearer ${getCookie('token')}` }
                            });
                            const data = await response.json();
                            console.log('Validate response:', data);
                            if (response.ok && data.valid) {
                                document.getElementById('adminBtn').classList.toggle('hidden', data.role !== 'admin');
                                resolve({ email: user.email, role: data.role });
                            } else {
                                console.log('Invalid token, signing out');
                                await auth.signOut();
                                deleteCookie('token');
                                switchPage(loginPage, homePage);
                                resolve(null);
                            }
                        } catch (error) {
                            console.error('Auth check error:', error);
                            await auth.signOut();
                            deleteCookie('token');
                            switchPage(loginPage, homePage);
                            resolve(null);
                        }
                    } else {
                        console.log('No user authenticated');
                        deleteCookie('token');
                        switchPage(loginPage, homePage);
                        resolve(null);
                    }
                });
            });
        }

        // Load data from JSON files and user data
        async function loadData(email) {
            try {
                const [productsRes, denominationsRes, flashSalesRes, purchasesRes, ordersRes] = await Promise.all([
                    fetch('/data/products.json'),
                    fetch('/data/denominations.json'),
                    fetch('/data/flashsales.json'),
                    fetch('/data/purchases.json'),
                    email ? fetch('/api/orders', {
                        headers: { 'Authorization': `Bearer ${getCookie('token')}` }
                    }) : Promise.resolve({ json: () => [] })
                ]);
                const products = await productsRes.json();
                const denominations = await denominationsRes.json();
                const flashSales = await flashSalesRes.json();
                const purchases = await purchasesRes.json();
                const orders = email ? await ordersRes.json() : [];

                console.log('Loaded data:', { products, denominations, flashSales, purchases, orders });

                // Populate product grid
                const productGrid = document.getElementById('productGrid');
                productGrid.innerHTML = products.map(product => `
                    <button class="product-btn bg-blue-500 text-white p-4 rounded-xl flex items-center justify-center" data-product="${product.name}">
                        <img src="${product.image}" class="w-10 h-10 mr-2" alt="${product.name}">
                        <span>${product.name}</span>
                    </button>
                `).join('');

                // Populate denomination grid
                const denomGrid = document.getElementById('denomGrid');
                denomGrid.innerHTML = denominations.map(denom => `
                    <button type="button" class="denom-btn flex items-center p-2 border rounded-xl hover:bg-gray-100 transition-colors" data-denom="${denom.name}" data-price="${denom.price}">
                        <img src="${denom.image}" alt="${denom.name}" class="w-8 h-8 mr-2">
                        <span>${denom.name}</span>
                    </button>
                `).join('');

                // Populate flash sale
                const flashSaleContainer = document.getElementById('flashSaleContainer');
                flashSaleContainer.innerHTML = flashSales.map((sale, index) => `
                    <button class="flash-sale-btn flash-sale-slide ${index === 0 ? 'active' : ''} flex items-center justify-center bg-yellow-100 p-4 rounded-xl" data-product="${sale.product}" data-denom="${sale.denom}" data-price="${sale.price}">
                        <svg class="w-6 h-6 text-yellow-500 lightning mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                        <span class="font-semibold text-gray-800">${sale.text}</span>
                    </button>
                `).join('');

                // Populate purchase popup
                const purchasePopup = document.getElementById('purchasePopup');
                const purchaseContent = document.getElementById('purchaseContent');
                let currentPurchaseIndex = 0;

                function updatePurchasePopup() {
                    const purchase = purchases[currentPurchaseIndex];
                    const censoredUserId = purchase.userId.slice(0, 3) + '*'.repeat(purchase.userId.length - 3);
                    const censoredServerId = purchase.serverId.slice(0, 2) + '*'.repeat(purchase.serverId.length - 2);
                    const censoredUsername = purchase.username.slice(0, 2) + '*'.repeat(purchase.username.length - 2);
                    purchaseContent.innerHTML = `
                        <p><strong>Product:</strong> ${purchase.product}</p>
                        <p><strong>Denomination:</strong> ${purchase.denom}</p>
                        <p><strong>User ID:</strong> ${censoredUserId}</p>
                        <p><strong>Server ID:</strong> ${censoredServerId}</p>
                        <p><strong>Username:</strong> ${censoredUsername}</p>
                    `;
                    purchasePopup.classList.add('active');
                    setTimeout(() => {
                        purchasePopup.classList.remove('active');
                        currentPurchaseIndex = (currentPurchaseIndex + 1) % purchases.length;
                        setTimeout(updatePurchasePopup, 500);
                    }, 2500);
                }

                if (purchases.length > 0) {
                    updatePurchasePopup();
                    setInterval(updatePurchasePopup, 3000);
                }

                // Populate order history
                const orderHistory = document.getElementById('orderHistory');
                orderHistory.innerHTML = orders.length > 0 ? orders.map(order => `
                    <div class="border-b py-2">
                        <p><strong>Product:</strong> ${order.product}</p>
                        <p><strong>Denomination:</strong> ${order.denomination}</p>
                        <p><strong>Price:</strong> Rp${order.price}</p>
                        <p><strong>User ID:</strong> ${order.userId}</p>
                        <p><strong>Server ID:</strong> ${order.serverId}</p>
                        <p><strong>Username:</strong> ${order.username}</p>
                        <p><strong>Region:</strong> ${order.region}</p>
                        <p><strong>Payment Method:</strong> ${order.paymentMethod}</p>
                        <p><strong>Date:</strong> ${new Date(order.timestamp).toLocaleString()}</p>
                    </div>
                `).join('') : '<p>No orders yet.</p>';

                // Populate profile
                if (email) {
                    document.getElementById('profileEmail').textContent = `Email: ${email}`;
                }

                // Flash sale navigation
                let currentFlashSaleIndex = 0;
                const flashSaleButtons = document.querySelectorAll('.flash-sale-btn');
                const prevFlashSale = document.getElementById('prevFlashSale');
                const nextFlashSale = document.getElementById('nextFlashSale');

                function updateFlashSale() {
                    flashSaleButtons.forEach((btn, index) => {
                        btn.classList.toggle('active', index === currentFlashSaleIndex);
                    });
                }

                prevFlashSale.addEventListener('click', () => {
                    currentFlashSaleIndex = (currentFlashSaleIndex - 1 + flashSales.length) % flashSales.length;
                    updateFlashSale();
                });

                nextFlashSale.addEventListener('click', () => {
                    currentFlashSaleIndex = (currentFlashSaleIndex + 1) % flashSales.length;
                    updateFlashSale();
                });

                setInterval(() => {
                    currentFlashSaleIndex = (currentFlashSaleIndex + 1) % flashSales.length;
                    updateFlashSale();
                }, 5000);

                // Re-attach event listeners
                document.querySelectorAll('.product-btn').forEach(button => {
                    button.addEventListener('click', () => {
                        switchPage(orderFormPage, homePage, button.dataset.product);
                    });
                });

                const denomButtons = document.querySelectorAll('.denom-btn');
                denomButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        denomButtons.forEach(btn => btn.classList.remove('selected'));
                        button.classList.add('selected');
                        denominationInput.value = button.dataset.denom;
                        priceInput.value = button.dataset.price;
                        validateForm();
                    });
                });

                flashSaleButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        switchPage(orderFormPage, homePage, button.dataset.product, button.dataset.denom, button.dataset.price);
                        denomButtons.forEach(btn => btn.classList.remove('selected'));
                        const denomBtn = document.querySelector(`.denom-btn[data-denom="${button.dataset.denom}"]`);
                        if (denomBtn) {
                            denomBtn.classList.add('selected');
                        }
                        validateForm();
                    });
                });
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        // Load admin panel data
        async function loadAdminPanel() {
            try {
                const response = await fetch('/api/users', {
                    headers: { 'Authorization': `Bearer ${getCookie('token')}` }
                });
                const users = await response.json();
                console.log('Admin panel users:', users);
                if (!response.ok) {
                    throw new Error(users.message || 'Failed to load users');
                }
                const userTable = document.getElementById('userTable');
                userTable.innerHTML = users.map(user => `
                    <tr>
                        <td class="p-2">${user.email}</td>
                        <td class="p-2">${user.role}</td>
                        <td class="p-2">
                            <button class="edit-user-btn bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600" data-email="${user.email}" data-role="${user.role}">Edit</button>
                            <button class="delete-user-btn bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600" data-email="${user.email}">Delete</button>
                        </td>
                    </tr>
                `).join('');

                // Add event listeners for edit and delete buttons
                document.querySelectorAll('.edit-user-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const email = btn.dataset.email;
                        const newRole = prompt('Enter new role (user/admin):', btn.dataset.role);
                        if (newRole && (newRole === 'user' || newRole === 'admin')) {
                            try {
                                const response = await fetch('/api/users', {
                                    method: 'PUT',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${getCookie('token')}`
                                    },
                                    body: JSON.stringify({ email, newRole })
                                });
                                const data = await response.json();
                                if (response.ok) {
                                    alert('User updated successfully');
                                    loadAdminPanel();
                                } else {
                                    alert(data.message || 'Failed to update user');
                                }
                            } catch (error) {
                                alert('Error updating user: ' + error.message);
                                console.error('Update user error:', error);
                            }
                        } else {
                            alert('Invalid role');
                        }
                    });
                });

                document.querySelectorAll('.delete-user-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        if (confirm(`Are you sure you want to delete ${btn.dataset.email}?`)) {
                            try {
                                const response = await fetch('/api/users', {
                                    method: 'DELETE',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${getCookie('token')}`
                                    },
                                    body: JSON.stringify({ email: btn.dataset.email })
                                });
                                const data = await response.json();
                                if (response.ok) {
                                    alert('User deleted successfully');
                                    loadAdminPanel();
                                } else {
                                    alert(data.message || 'Failed to delete user');
                                }
                            } catch (error) {
                                alert('Error deleting user: ' + error.message);
                                console.error('Delete user error:', error);
                            }
                        }
                    });
                });
            } catch (error) {
                console.error('Error loading admin panel:', error);
                alert('Failed to load admin panel: ' + error.message);
                switchPage(homePage, adminPage);
            }
        }

        // Page navigation with fade animation
        const loginPage = document.getElementById('loginPage');
        const registerPage = document.getElementById('registerPage');
        const homePage = document.getElementById('homePage');
        const orderFormPage = document.getElementById('orderFormPage');
        const adminPage = document.getElementById('adminPage');
        const productTitle = document.getElementById('productTitle');
        const backBtn = document.getElementById('backBtn');
        const backToHomeBtn = document.getElementById('backToHomeBtn');

        function switchPage(show, hide, product = '', denom = '', price = '') {
            hide.classList.add('fade-exit');
            setTimeout(() => {
                hide.classList.add('hidden');
                hide.classList.remove('fade-exit');
                show.classList.remove('hidden');
                show.classList.add('fade-enter');
                setTimeout(() => show.classList.remove('fade-enter'), 500);
                if (product) {
                    productTitle.textContent = product;
                    if (denom && price) {
                        denominationInput.value = denom;
                        priceInput.value = price;
                        document.querySelectorAll('.denom-btn').forEach(btn => btn.classList.remove('selected'));
                        document.querySelector(`.denom-btn[data-denom="${denom}"]`)?.classList.add('selected');
                        validateForm();
                    }
                }
                confirmationPopup.classList.add('hidden');
                confirmationPopup.style.display = 'none';
            }, 500);
        }

        // Login form
        if (document.getElementById('loginForm')) {
            document.getElementById('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!auth) {
                    console.error('Auth not initialized');
                    document.getElementById('loginMessage').textContent = 'Authentication service unavailable';
                    document.getElementById('loginMessage').classList.add('text-red-500', 'show');
                    return;
                }
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                const loginMessage = document.getElementById('loginMessage');

                console.log('Attempting login with:', { email });

                try {
                    const userCredential = await auth.signInWithEmailAndPassword(email, password);
                    const user = userCredential.user;
                    console.log('Firebase login successful:', user.email);
                    const idToken = await user.getIdToken();
                    const response = await fetch('/api/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ idToken })
                    });
                    const text = await response.text();
                    console.log('Login response:', { status: response.status, text });
                    try {
                        const data = JSON.parse(text);
                        if (response.ok) {
                            setCookie('token', data.token, 30);
                            loginMessage.textContent = 'Login successful!';
                            loginMessage.classList.remove('text-red-500');
                            loginMessage.classList.add('text-green-500', 'show');
                            document.getElementById('loginForm').reset();
                            switchPage(homePage, loginPage);
                            loadData(email);
                        } else {
                            loginMessage.textContent = data.message || 'Invalid email or password';
                            loginMessage.classList.remove('text-green-500');
                            loginMessage.classList.add('text-red-500', 'show');
                        }
                    } catch (error) {
                        console.error('Login response is not JSON:', text);
                        loginMessage.textContent = 'Server error: Invalid response format';
                        loginMessage.classList.remove('text-green-500');
                        loginMessage.classList.add('text-red-500', 'show');
                    }
                } catch (error) {
                    console.error('Firebase login error:', error);
                    loginMessage.textContent = error.message || 'Error during login';
                    loginMessage.classList.remove('text-green-500');
                    loginMessage.classList.add('text-red-500', 'show');
                }
            });
        } else {
            console.error('loginForm element not found');
        }

        // Register form
        if (document.getElementById('registerForm')) {
            document.getElementById('registerForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!auth) {
                    console.error('Auth not initialized');
                    document.getElementById('registerMessage').textContent = 'Authentication service unavailable';
                    document.getElementById('registerMessage').classList.add('text-red-500', 'show');
                    return;
                }
                const email = document.getElementById('registerEmail').value;
                const password = document.getElementById('registerPassword').value;
                const registerMessage = document.getElementById('registerMessage');

                console.log('Attempting registration with:', { email });

                try {
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    const user = userCredential.user;
                    console.log('Firebase registration successful:', user.email);
                    const idToken = await user.getIdToken();
                    const response = await fetch('/api/register', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ idToken, email })
                    });
                    const text = await response.text();
                    console.log('Register response:', { status: response.status, text });
                    try {
                        const data = JSON.parse(text);
                        if (response.ok) {
                            setCookie('token', data.token, 30);
                            registerMessage.textContent = 'Registration successful!';
                            registerMessage.classList.remove('text-red-500');
                            registerMessage.classList.add('text-green-500', 'show');
                            document.getElementById('registerForm').reset();
                            switchPage(homePage, registerPage);
                            loadData(email);
                        } else {
                            registerMessage.textContent = data.message || 'Error during registration';
                            registerMessage.classList.remove('text-green-500');
                            registerMessage.classList.add('text-red-500', 'show');
                        }
                    } catch (error) {
                        console.error('Register response is not JSON:', text);
                        registerMessage.textContent = 'Server error: Invalid response format';
                        registerMessage.classList.remove('text-green-500');
                        registerMessage.classList.add('text-red-500', 'show');
                    }
                } catch (error) {
                    console.error('Firebase registration error:', error);
                    registerMessage.textContent = error.message || 'Error during registration';
                    registerMessage.classList.remove('text-green-500');
                    registerMessage.classList.add('text-red-500', 'show');
                }
            });
        } else {
            console.error('registerForm element not found');
        }

        // Toggle between login and register
        if (document.getElementById('showRegister')) {
            document.getElementById('showRegister').addEventListener('click', (e) => {
                e.preventDefault();
                switchPage(registerPage, loginPage);
            });
        } else {
            console.error('showRegister element not found');
        }

        if (document.getElementById('showLogin')) {
            document.getElementById('showLogin').addEventListener('click', (e) => {
                e.preventDefault();
                switchPage(loginPage, registerPage);
            });
        } else {
            console.error('showLogin element not found');
        }

        // Logout
        if (document.getElementById('logoutBtn')) {
            document.getElementById('logoutBtn').addEventListener('click', async () => {
                console.log('Logging out');
                try {
                    if (auth) {
                        await auth.signOut();
                    }
                    await fetch('/api/logout', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${getCookie('token')}` }
                    });
                    deleteCookie('token');
                    switchPage(loginPage, homePage);
                    document.getElementById('orderForm').reset();
                    document.getElementById('orderHistory').innerHTML = '';
                    document.getElementById('profileEmail').textContent = '';
                } catch (error) {
                    console.error('Logout error:', error);
                }
            });
        } else {
            console.error('logoutBtn element not found');
        }

        // Admin panel navigation
        if (document.getElementById('adminBtn')) {
            document.getElementById('adminBtn').addEventListener('click', () => {
                console.log('Navigating to admin panel');
                switchPage(adminPage, homePage);
                loadAdminPanel();
            });
        } else {
            console.error('adminBtn element not found');
        }

        if (document.getElementById('backToHomeBtn')) {
            document.getElementById('backToHomeBtn').addEventListener('click', () => {
                console.log('Returning to home from admin panel');
                switchPage(homePage, adminPage);
            });
        } else {
            console.error('backToHomeBtn element not found');
        }

        // Handle denomination selection
        const denominationInput = document.getElementById('denomination');
        const priceInput = document.getElementById('price');

        // Handle payment method selection
        const paymentButtons = document.querySelectorAll('.payment-btn');
        const paymentInput = document.getElementById('paymentMethod');

        paymentButtons.forEach(button => {
            button.addEventListener('click', () => {
                paymentButtons.forEach(btn => btn.classList.remove('selected'));
                button.classList.add('selected');
                paymentInput.value = button.dataset.payment;
                validateForm();
            });
        });

        // Handle user ID and server validation
        const userIdInput = document.getElementById('userId');
        const serverIdInput = document.getElementById('serverId');
        const usernameInput = document.getElementById('username');
        const regionInput = document.getElementById('region');
        const validationMessage = document.getElementById('validationMessage');
        const submitBtn = document.getElementById('submitBtn');
        const userIdSpinner = document.getElementById('userIdSpinner');
        const serverIdSpinner = document.getElementById('serverIdSpinner');
        const confirmationPopup = document.getElementById('confirmationPopup');

        let validationTimeout = null;

        async function validateUser() {
            const userId = userIdInput.value.trim();
            const serverId = serverIdInput.value.trim();

            if (validationTimeout) {
                clearTimeout(validationTimeout);
            }

            userIdSpinner.style.display = userId ? 'inline-block' : 'none';
            serverIdSpinner.style.display = serverId ? 'inline-block' : 'none';
            validationMessage.textContent = '';
            validationMessage.classList.remove('show', 'text-green-500', 'text-red-500');
            usernameInput.value = '';
            regionInput.value = '';
            submitBtn.disabled = true;

            if (userId && serverId) {
                validationTimeout = setTimeout(async () => {
                    try {
                        const url = `https://dev.luckycat.my.id/api/stalker/mobile-legend?users=${encodeURIComponent(userId)}&servers=${encodeURIComponent(serverId)}`;
                        const response = await fetch(url);
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        const data = await response.json();

                        if (data.status === true && data.data && typeof data.data.nickname === 'string' && typeof data.data.country === 'string') {
                            usernameInput.value = data.data.nickname;
                            regionInput.value = data.data.country;
                            validationMessage.textContent = 'Username and region validated successfully!';
                            validationMessage.classList.remove('text-red-500');
                            validationMessage.classList.add('text-green-500', 'show');
                            validateForm();
                        } else {
                            usernameInput.value = '';
                            regionInput.value = '';
                            validationMessage.textContent = 'Invalid User ID or Server ID';
                            validationMessage.classList.remove('text-green-500');
                            validationMessage.classList.add('text-red-500', 'show');
                            submitBtn.disabled = true;
                        }
                    } catch (error) {
                        usernameInput.value = '';
                        regionInput.value = '';
                        validationMessage.textContent = 'Error validating username and region: ' + error.message;
                        validationMessage.classList.remove('text-green-500');
                        validationMessage.classList.add('text-red-500', 'show');
                        submitBtn.disabled = true;
                        console.error('Validation error:', error);
                    } finally {
                        userIdSpinner.style.display = 'none';
                        serverIdSpinner.style.display = 'none';
                    }
                }, 500);
            } else {
                userIdSpinner.style.display = 'none';
                serverIdSpinner.style.display = 'none';
                validationMessage.textContent = '';
                validationMessage.classList.remove('show');
                submitBtn.disabled = true;
            }
        }

        userIdInput.addEventListener('input', validateUser);
        serverIdInput.addEventListener('input', validateUser);

        // Validate form to enable/disable submit button
        function validateForm() {
            const isValid = denominationInput.value && paymentInput.value && usernameInput.value && regionInput.value;
            submitBtn.disabled = !isValid;
            console.log('Form validation:', {
                denomination: denominationInput.value,
                paymentMethod: paymentInput.value,
                username: usernameInput.value,
                region: regionInput.value,
                submitBtnDisabled: submitBtn.disabled
            });
        }

        // Handle form submission with confirmation popup
        const popupContent = document.getElementById('popupContent');
        const confirmPopup = document.getElementById('confirmPopup');
        const cancelPopup = document.getElementById('cancelPopup');

        if (document.getElementById('orderForm')) {
            document.getElementById('orderForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                console.log('Order form submitted');
                const product = productTitle.textContent;
                const denomination = denominationInput.value;
                const price = priceInput.value;
                const userId = userIdInput.value;
                const serverId = serverIdInput.value;
                const username = usernameInput.value;
                const region = regionInput.value;
                const paymentMethod = paymentInput.value;

                popupContent.innerHTML = `
                    <p><strong>Product:</strong> ${product}</p>
                    <p><strong>Denomination:</strong> ${denomination}</p>
                    <p><strong>Price:</strong> Rp${price}</p>
                    <p><strong>User ID:</strong> ${userId}</p>
                    <p><strong>Server ID:</strong> ${serverId}</p>
                    <p><strong>Username:</strong> ${username}</p>
                    <p><strong>Region:</strong> ${region}</p>
                    <p><strong>Payment Method:</strong> ${paymentMethod}</p>
                `;
                confirmationPopup.classList.remove('hidden');
                confirmationPopup.style.display = 'flex';

                confirmPopup.onclick = async () => {
                    console.log('Confirm order clicked');
                    const message = `New Order:\nProduct: ${product}\nDenomination: ${denomination}\nPrice: Rp${price}\nUser ID: ${userId}\nServer ID: ${serverId}\nUsername: ${username}\nRegion: ${region}\nPayment Method: ${paymentMethod}`;
                    const whatsappUrl = `https://wa.me/+6281234567890?text=${encodeURIComponent(message)}`;
                    try {
                        const idToken = await auth.currentUser.getIdToken();
                        await fetch('/api/orders', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${idToken}`
                            },
                            body: JSON.stringify({
                                product,
                                denomination,
                                price,
                                userId,
                                serverId,
                                username,
                                region,
                                paymentMethod,
                                timestamp: new Date().toISOString()
                            })
                        });
                        window.open(whatsappUrl, '_blank');
                        confirmationPopup.classList.add('hidden');
                        confirmationPopup.style.display = 'none';
                        switchPage(homePage, orderFormPage);
                        document.getElementById('orderForm').reset();
                        denominationInput.value = '';
                        priceInput.value = '';
                        paymentInput.value = '';
                        usernameInput.value = '';
                        regionInput.value = '';
                        validationMessage.textContent = '';
                        validationMessage.classList.remove('show', 'text-green-500', 'text-red-500');
                        submitBtn.disabled = true;
                        document.querySelectorAll('.denom-btn').forEach(btn => btn.classList.remove('selected'));
                        document.querySelectorAll('.payment-btn').forEach(btn => btn.classList.remove('selected'));
                        const authData = await checkAuth();
                        if (authData) loadData(authData.email);
                    } catch (error) {
                        console.error('Order save error:', error);
                    }
                };

                cancelPopup.onclick = () => {
                    console.log('Cancel order clicked');
                    confirmationPopup.classList.add('hidden');
                    confirmationPopup.style.display = 'none';
                };
            });
        } else {
            console.error('orderForm element not found');
        }

        backBtn.addEventListener('click', () => {
            console.log('Back button clicked');
            switchPage(homePage, orderFormPage);
            document.getElementById('orderForm').reset();
            denominationInput.value = '';
            priceInput.value = '';
            paymentInput.value = '';
            usernameInput.value = '';
            regionInput.value = '';
            validationMessage.textContent = '';
            validationMessage.classList.remove('show', 'text-green-500', 'text-red-500');
            submitBtn.disabled = true;
            document.querySelectorAll('.denom-btn').forEach(btn => btn.classList.remove('selected'));
            document.querySelectorAll('.payment-btn').forEach(btn => btn.classList.remove('selected'));
            userIdSpinner.style.display = 'none';
            serverIdSpinner.style.display = 'none';
            confirmationPopup.classList.add('hidden');
            confirmationPopup.style.display = 'none';
        });

        // Initialize
        checkAuth().then(auth => {
            console.log('Initial auth check:', auth);
            if (auth) {
                switchPage(homePage, loginPage);
                loadData(auth.email);
            }
        });
    </script>
</body>
</html>
